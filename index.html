<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padelucky - Máquina de la Suerte</title>
    <style>
        /* Tus estilos */
        .modal { display: none; }
        .modal.show { display: flex; }
        .close { position: absolute; top: 10px; right: 10px; cursor: pointer; }
        .selected { background-color: yellow; }
    </style>
</head>
<body>
    <div class="container">
        <h1>¡Bienvenidos a Padelucky!</h1>
        <p>Edición #1 Adidas Metalbone HRD 2024 Ale Galán, participa con nuestra máquina de la suerte - Sorteo 1ro de julio</p>
        <div class="machine">
            <div class="number-input">
                <label for="numTickets">¿Cuántos números quieres?</label>
                <input type="number" id="numTickets" min="1" max="149" value="1">
            </div>
            <button class="button" onclick="generateNumbers()">La Máquina de la Suerte</button>
            <div class="number-list" id="numberList"></div>
            <div id="totalCost"></div>
            <a id="apartButton" class="button" href="#" style="display: none;" onclick="showForm()">Apartar</a>
        </div>
        <div class="ticket-table">
            <h2>Boletos Disponibles</h2>
            <table id="availableTicketsTable">
                <tbody id="availableTicketsBody"></tbody>
            </table>
        </div>
        <div class="verifier">
            <h2>Verificar Boleto</h2>
            <input type="number" id="verifyTicket" min="1" max="149" placeholder="Número de boleto">
            <button class="button" onclick="verifyTicket()">Verificar</button>
            <p id="verifyResult"></p>
        </div>
        <button class="button" onclick="showAccess()">Acceso</button>
    </div>

    <div id="formModal" class="modal">
        <div class="form-container">
            <button class="close" onclick="closeModal('formModal')">x</button>
            <h2>Apartar Boleto(s)</h2>
            <input type="text" id="customerName" placeholder="Nombre Completo" required>
            <input type="tel" id="customerPhone" placeholder="Número de Celular" required>
            <input type="text" id="customerState" placeholder="Estado de Residencia" required>
            <button onclick="submitForm()">Enviar</button>
        </div>
    </div>

    <div id="accessModal" class="modal">
        <div class="form-container">
            <button class="close" onclick="closeModal('accessModal')">x</button>
            <h2>Acceso</h2>
            <input type="password" id="adminPassword" placeholder="Contraseña" required>
            <button onclick="validateAccess()">Entrar</button>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="form-container">
            <button class="close" onclick="closeModal('adminModal')">x</button>
            <h2>Boletos Apartados</h2>
            <input type="number" id="searchTicket" placeholder="Buscar Boleto">
            <button onclick="searchBookedTicket()">Buscar</button>
            <table id="bookedTicketsTable">
                <thead>
                    <tr>
                        <th>Número de Boleto</th>
                        <th>Nombre</th>
                        <th>Teléfono</th>
                        <th>Estado</th>
                        <th>Reactivar</th>
                    </tr>
                </thead>
                <tbody id="bookedTicketsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCjpLyfV-wo9uM6K14N0q9DzsabKIIX4gA",
            authDomain: "padelucky-e80e6.firebaseapp.com",
            projectId: "padelucky-e80e6",
            storageBucket: "padelucky-e80e6.appspot.com",
            messagingSenderId: "87499387761",
            appId: "1:87499387761:web:e446eb19d6505e924afcd0"
            measurementId: "G-HZRERWE8TS"
        };
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const firestore = firebase.firestore(app);

        let selectedNumbers = [];
        const totalTickets = 149;
        const ticketPrice = 99;
        let bookedTickets = {};

        async function fetchBookedTickets() {
            const snapshot = await db.collection('tickets').get();
            bookedTickets = {};
            snapshot.forEach(doc => {
                bookedTickets[doc.id] = doc.data();
            });
            updateAvailableTicketsTable();
        }

        function generateNumbers() {
            const numTickets = parseInt(document.getElementById('numTickets').value);
            selectedNumbers = [];
            for (let i = 0; i < numTickets; i++) {
                let randomNum;
                do {
                    randomNum = Math.floor(Math.random() * totalTickets) + 1;
                } while (selectedNumbers.includes(randomNum) || bookedTickets[randomNum]);
                selectedNumbers.push(randomNum);
            }
            updateNumberList();
        }

        function updateAvailableTicketsTable() {
            const availableTicketsBody = document.getElementById('availableTicketsBody');
            availableTicketsBody.innerHTML = '';
            let tr;
            for (let i = 1; i <= totalTickets; i++) {
                if ((i - 1) % 12 === 0) {
                    tr = document.createElement('tr');
                }
                const td = document.createElement('td');
                td.textContent = String(i).padStart(3, '0');
                if (!bookedTickets[i]) {
                    td.onclick = () => selectTicket(i, td);
                } else {
                    td.style.backgroundColor = "#ddd";
                }
                tr.appendChild(td);
                if (i % 12 === 0) {
                    availableTicketsBody.appendChild(tr);
                }
            }
            if (totalTickets % 12 !== 0) {
                availableTicketsBody.appendChild(tr);
            }
        }

        function selectTicket(ticketNumber, td) {
            if (!selectedNumbers.includes(ticketNumber)) {
                selectedNumbers.push(ticketNumber);
                td.classList.add('selected');
                td.onclick = () => deselectTicket(ticketNumber, td);
                updateNumberList();
            }
        }

        function deselectTicket(ticketNumber, td) {
            selectedNumbers = selectedNumbers.filter(num => num !== ticketNumber);
            td.classList.remove('selected');
            td.onclick = () => selectTicket(ticketNumber, td);
            updateNumberList();
        }

        function updateNumberList() {
            const numberListDiv = document.getElementById('numberList');
            numberListDiv.innerHTML = '';
            selectedNumbers.forEach(num => {
                const span = document.createElement('span');
                span.textContent = String(num).padStart(3, '0');
                numberListDiv.appendChild(span);
            });

            const apartButton = document.getElementById('apartButton');
            const totalCostDiv = document.getElementById('totalCost');
            if (selectedNumbers.length > 0) {
                apartButton.style.display = 'inline-block';
                const totalCost = selectedNumbers.length * ticketPrice;
                totalCostDiv.textContent = `Costo Total: $${totalCost} pesos`;
            } else {
                apartButton.style.display = 'none';
                totalCostDiv.textContent = '';
            }
        }

        function showForm() {
            document.getElementById('formModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function submitForm() {
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const customerState = document.getElementById('customerState').value;

            if (!customerName || !customerPhone || !customerState) {
                alert('Por favor, complete todos los campos.');
                return;
            }

            const batch = db.batch();
            selectedNumbers.forEach(num => {
                const docRef = db.collection('tickets').doc(num.toString());
                batch.set(docRef, { name: customerName, phone: customerPhone, state: customerState });
            });
            await batch.commit();

            const message = `${customerName}\nBoleto(s) No. ${selectedNumbers.join(', ')} apartado(s)\nAl Aceptar, estarás de acuerdo con los términos y condiciones del sorteo y serás direccionado a WhatsApp, favor de mandar su pago para recibir sus boletos.`;
            alert(message);

            const whatsappUrl = `https://wa.me/526647185248?text=${encodeURIComponent(message)}%0AUNICAMENTE%20MANDE%20SU%20COMPROBANTE%20DE%20PAGO%20AQUI%20EN%20ESTA%20LINEA%20Y%20ESPERE%20SU%20TURNO%20✅️%20⚠️%20REVISE%20CUANTOS%20BOLETOS%20APARTO%20Y%20SOLO%20PAGUE%20LA%20CANTIDAD%20CORRECTA.%20*Apartado%20valido%20por%203%20horas`;
            window.location.href = whatsappUrl;

            closeModal('formModal');
            selectedNumbers = [];
            updateNumberList();
            fetchBookedTickets();
        }

        function verifyTicket() {
            const ticketNumber = parseInt(document.getElementById('verifyTicket').value);
            const verifyResult = document.getElementById('verifyResult');

            if (bookedTickets[ticketNumber]) {
                const { name, phone, state } = bookedTickets[ticketNumber];
                verifyResult.textContent = `Boleto No. ${String(ticketNumber).padStart(3, '0')} - Apartado por: ${name}, Tel: ${phone}, Estado: ${state}`;
            } else {
                verifyResult.textContent = `Boleto No. ${String(ticketNumber).padStart(3, '0')} está disponible.`;
            }
        }

        function showAccess() {
            document.getElementById('accessModal').classList.add('show');
        }

        function validateAccess() {
            const password = document.getElementById('adminPassword').value;
            if (password === "560$Iimams") {
                closeModal('accessModal');
                showAdminPanel();
            } else {
                alert('Contraseña incorrecta');
            }
        }

        function showAdminPanel() {
            document.getElementById('adminModal').classList.add('show');
            updateBookedTicketsTable();
        }

        function updateBookedTicketsTable() {
            const bookedTicketsBody = document.getElementById('bookedTicketsBody');
            bookedTicketsBody.innerHTML = '';
            for (const [ticketNumber, { name, phone, state }] of Object.entries(bookedTickets)) {
                const tr = document.createElement('tr');
                const tdNumber = document.createElement('td');
                tdNumber.textContent = String(ticketNumber).padStart(3, '0');
                const tdName = document.createElement('td');
                tdName.textContent = name;
                const tdPhone = document.createElement('td');
                tdPhone.textContent = phone;
                const tdState = document.createElement('td');
                tdState.textContent = state;
                const tdReactivate = document.createElement('td');
                const reactivateButton = document.createElement('button');
                reactivateButton.textContent = 'Reactivar';
                reactivateButton.onclick = () => reactivateTicket(ticketNumber);
                tdReactivate.appendChild(reactivateButton);
                tr.appendChild(tdNumber);
                tr.appendChild(tdName);
                tr.appendChild(tdPhone);
                tr.appendChild(tdState);
                tr.appendChild(tdReactivate);
                bookedTicketsBody.appendChild(tr);
            }
        }

        function searchBookedTicket() {
            const searchTicket = parseInt(document.getElementById('searchTicket').value);
            const bookedTicketsBody = document.getElementById('bookedTicketsBody');
            for (let row of bookedTicketsBody.rows) {
                if (parseInt(row.cells[0].textContent) === searchTicket) {
                    row.scrollIntoView();
                    row.style.backgroundColor = "#ffcc00";
                } else {
                    row.style.backgroundColor = "";
                }
            }
        }

        async function reactivateTicket(ticketNumber) {
            await db.collection('tickets').doc(ticketNumber.toString()).delete();
            fetchBookedTickets();
        }

        window.onload = fetchBookedTickets;
    </script>
</body>
</html>
